# Collabverse Stage 0

## Требования
- Node.js 20 (см. `.nvmrc`)
- pnpm 9

## Установка и запуск
1. Установите зависимости: `pnpm install`
2. Подготовьте переменные окружения: `pnpm ensure-env`
3. Режим разработки: `pnpm dev` (откройте `http://localhost:3000/`)
4. Продакшен-сборка: `pnpm build && pnpm start`

> Preflight Stage 4 — пройден.

## Тесты
- Юнит-тесты: `pnpm test`
- E2E: `pnpm test:e2e`

## Переменные окружения
- `NAV_V1` — флаг навигации (off/on)
- `APP_LOCALE` — локаль приложения (по умолчанию ru)
- На Vercel (Preview/Production) установите `NAV_V1=on` и `APP_LOCALE=ru` в настройках проекта.

## Этапы
- **Этап 0** — базовый каркас и инфраструктура
- **Этап 1** — развитие функционала, маркетинговый слой
- **Этап 4** — защита от ошибок и устойчивость

## Pre-5 RC: как пройти предварительную проверку
- Подготовьте окружение: `pnpm install`, `cp .env.example .env`, установите `NAV_V1=on`, `APP_LOCALE=ru` и остальные флаги навигации, требуемые для гостевого слоя.
- Включите гостевой слой и демо-проекты, затем убедитесь, что маркетинговые, дашбордные и проектные маршруты не выводят ошибок или предупреждений в браузерной консоли.
- Запустите полный прогон `pnpm verify`: линтер, проверка типов, сборка, юнит- и e2e-тесты, аудит маршрутов и `vercel build --prod`.
- После `pnpm verify` локально повторите e2e-смоук (основные маркетинговые страницы, дашборд, демо-проект, публичные заглушки) и проверьте меню на десктопе и мобильных точках.
- Сымитируйте 404 и ошибку внутри вкладки проекта, чтобы подтвердить работу границ ошибок и страниц `error`, `not-found`, `loading`.
- Убедитесь, что локальная симуляция Vercel-сборки (путь проекта, версия Node.js 20, пакетный менеджер pnpm 9) проходит без внешних запросов и что все заявленные маршруты отдают `200`.

## Этап 1: страницы и навигация
- Маркетинговый слой включает главную страницу, продуктовые разделы (`/product/*`), аудиторию, каталоги проектов, специалистов и подрядчиков, тарифы, блог и формы входа/регистрации. Для QA доступны зеркальные маршруты с префиксом `/mkt`.
- Двухуровневое меню: мегаменю на десктопе и мобильное меню-аккордеон. Конфигурация расположена в `apps/web/config/MarketingMenu.config.ts`.
- Общий layout маркетинговых страниц подключает шапку и футер, а домашняя страница состоит из секций Hero, Features, Audience и CTA.
- Чтобы включить маркетинговый слой на главной `/`, установите `NAV_V1=on` в `.env`. При `NAV_V1=off` отображается заглушка Stage 0.
- Обновлённые sitemap и robots перечисляют все маркетинговые маршруты. Перед публикацией выполните `pnpm test` и `pnpm test:e2e`.

## Этап 4 — защита от ошибок
- Добавлены единые `error.tsx`, `not-found.tsx` и `loading.tsx` для корневого уровня, маркетинга, приложений и проекта: состояние ошибки сопровождается кнопкой «Повторить попытку», страницы 404 ведут на главную и к списку проектов.
- Моки валидируются в рантайме через `zod`: лоадеры из `apps/web/lib/mock/loaders.ts` возвращают пустой массив и логируют проблему в dev-режиме, если структура JSON не соответствует схеме.
- Команда `pnpm verify` запускает полный пайплайн (линт, typecheck, build, unit, e2e, проверку маршрутов и `vercel build --prod`). GitHub Actions и husky `pre-push` используют этот же скрипт.
- E2E-покрытие усилено: добавлены сценарии для мегаменю, 404 и error-boundary, в тестах фиксируются `console.error`/`console.warn` на ключевых страницах.

## Как устроено мегаменю (A11y)
- Верхнеуровневая кнопка раскрывает панель при фокусе, а также по клавишам `Enter`, `Space` и `ArrowDown`. Состояние отражается через `aria-expanded="true"|"false"` и `aria-controls`.
- Панель мегаменю имеет `role="menu"`, все ссылки объявлены как `role="menuitem"`. Фокус не пропадает при переходе между элементами благодаря хэндлеру `onFocusCapture` и проверке `relatedTarget`.
- Навигация по клавише `Tab` зациклена внутри панели, `Escape` закрывает меню. Тест `menu-desktop.spec.ts` проверяет доступность и переход на «Обзор платформы».
