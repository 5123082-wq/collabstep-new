# План подготовки «pre-5 RC»

## 1. Preflight-проверка проекта
- Провести аудит зависимостей: выровнять версии Node.js 20 и pnpm 9, удалить неиспользуемые пакеты, обновить lock-файл при необходимости.
- Сверить содержимое `.env.example` и `.env`: обеспечить наличие флагов `NAV_V1`, `APP_LOCALE`, `FIN_EXPENSES_STORAGE` (обычно `memory` для dev), переменных демо-проектов и любых токенов, которые требуются лишь в dev.
- Включить гостевой навигационный слой и демо-данные в default-конфигурации, проверить, что при `pnpm dev` маркетинговая главная и приложение стартуют без ошибок в терминале.
- Зафиксировать набор команд в `package.json`/CI для единого прогона `pnpm verify`, чтобы локальная и CI-конфигурации совпадали.

## 2. Структура маршрутов и заглушки
- Проверить дерево `apps/web/app` на наличие ключевых layout'ов: маркетинговый (`(marketing)`), приложение (`(app)`), проектный сегмент (`projects/[id]`).
- Для обязательных страниц (маркетинговая главная `/`, оболочка приложения `/app`, демо-проект `/projects/demo`) убедиться, что присутствуют `page.tsx`, `layout.tsx`, `loading.tsx`, `error.tsx`, `not-found.tsx`.
- Пройтись по навигации (`apps/web/config/MarketingMenu.config.ts`, мобильное меню, футер) и добавить заглушки `page.tsx` в соответствующие каталоги, если маршруты отсутствуют. Заглушки должны возвращать `200` и простую информацию-заголовок.
- Подготовить заглушки для карточек специалистов, блоговых разделов и других ссылок, используемых в меню или футере.
- Добавить `apps/web/app/api/health/route.ts` с простым ответом `{ status: 'ok' }` без внешних запросов.

## 3. Навигация и доступность
- Аудировать компонент мегаменю (`apps/web/components/marketing/MarketingMegaMenu.tsx`): убедиться в наличии `aria-expanded`, `aria-controls`, обработчиков `onKeyDown` для `Enter`/`Space`/стрелок и закрытия по `Escape` и `onBlur`.
- Дополнить тесты (`apps/web/tests/e2e/menu-desktop.spec.ts`) проверкой, что раскрытие работает по фокусу и по клавиатуре, а закрытие срабатывает при уходе фокуса.
- Проверить мобильное меню (`apps/web/components/marketing/MarketingMobileNav.tsx`): управление бургер-кнопкой, аккордеон подпунктов, перенос фокуса на открытие и возврат при закрытии.
- Включить тесты для мобильного меню (playwright spec) и убедиться, что ошибки/предупреждения консоли фиксируются и приводят к падению теста.

## 4. Границы ошибок и состояния загрузки
- Убедиться, что глобальные `error.tsx`, `not-found.tsx`, `loading.tsx` размещены на верхнем уровне и в ключевых сегментах (`(marketing)`, `(app)`, `projects/[id]`).
- Для проектных вкладок в `apps/web/app/(app)/projects/[id]/(tabs)` добавить локальные boundaries и сценарий «повторить».
- Настроить обработчик неизвестного `id`: в загрузчике/серверном компоненте возвращать `notFound()` при отсутствии проекта в мок-данных.
- Написать e2e-сценарий, который имитирует ошибку вкладки и проверяет кнопку «Повторить».

## 5. Данные и устойчивость
- Проверить схемы Zod в `apps/web/lib/mock/schemas.ts`: расширить их для всех моков, используемых маркетинговыми и проектными страницами.
- Обновить лоадеры (`apps/web/lib/mock/loaders.ts`) так, чтобы при несоответствии схемы возвращался безопасный пустой набор и логирование ограничивалось dev-режимом.
- Удалить внешние запросы из `sitemap.ts`, `robots.ts` и других файлов, используемых при сборке, заменив их локальными моками.
- Пересмотреть локальный поиск: зафиксировать собственные типы, избегать конфликтов с типами сторонних библиотек (например, `@algolia/client-search`).

## 6. Стабильность гидрации
- Проверить, что интерактивные компоненты объявлены как клиентские (`'use client'`) и не смешивают серверные и клиентские хуки.
- Прогнать `pnpm dev` и открыть ключевые страницы, следить за предупреждениями гидрации в терминале и консоли браузера; устранить расхождения между серверным и клиентским рендером.
- Включить e2e-проверку на отсутствие `console.error`/`console.warn` во время навигации по основным маршрутам.

## 7. Конфигурация Vercel
- Обновить `vercel.json` или настройки проекта: указать корневую директорию `apps/web`, команду сборки `pnpm verify` или `pnpm build`, команду запуска `pnpm start`, версию Node.js 20 и pnpm 9.
- Задать переменные окружения для preview и production (локаль, флаги навигации, демо-данные) через Vercel Dashboard.
- Проверить `vercel build --prod`, убедиться, что нет предупреждений «файл не найден», особенно для зеркальных маркетинговых маршрутов.

## 8. Тестирование и контроль качества
- Запустить `pnpm verify` локально, убедиться в нулевом числе предупреждений/ошибок.
- После симуляции Vercel повторить e2e-тесты, убедиться, что сценарии мегаменю, мобильного меню, 404 и error-boundary проходят.
- Составить чек-лист ручного тестирования: маркетинговые страницы, дашборд, демо-проект, публичные заглушки, состояние 404/500, health-endpoint.
- Подготовить инструкцию для QA о том, что проверять на превью-деплое Vercel (маршруты, меню, отсутствие консольных предупреждений).

## 9. Готовность к публикации
- Задеплоить превью в Vercel, подтвердить доступность главной, маркетинговых подразделов, дашборда и демо-проекта.
- Зафиксировать дату и номер RC, обновить документацию (README, release-notes) ссылками на превью.
- Настроить мониторинг health-endpoint и базовые алерты перед открытием доступа команде.
